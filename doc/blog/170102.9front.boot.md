# Advanced Namespace Tools blog
### 2 January 2-17

## 9front plan9rc Boot Script Improvements

### Technical Debt Origins and Accounting

In 9front/ANTS there are two different boot methods supported: a modified version of the 9front bootrc script which includes an ANTS section to create the independent administrative namespace, or a 9front-specific version of the ANTS plan9rc script, selected by setting "bootcmd=plan9rc" in plan9.ini. 

(For systems which don't need to boot unattended, it is often useful to leave "bootfile=" blank in plan9.ini, which allows you to specify your choice of kernel and change/enter other plan9.ini variables before the kernel is loaded. You can also interrupt the pre-kernel boot by spamming any key on the keyboard to achieve the same result.)

The ANTS independent boot namespace has its origins in work I did in 2010 in Bell Labs Plan 9, which I called the "rootlessboot" kernel. In standard Labs plan 9, the boot process was handled by C programs until the handoff to /rc/bin/termrc or cpurc. The original version of the plan9rc script was written then, which replaced almost all of the C code and duplicated much of the original behavior while also creating an independent namespace making use of only kernel resources.

The original Labs boot design involved compiling the needed userspace programs for booting (fossil, venti, factotum, ipconfig) into the built-in /boot directory. I started by building off that mechanism by adding more and more programs into /boot. Very early in the process, I modified rc to look for /boot/rcmain instead of /rc/lib/rcmain, and changed the default path to include /boot along with the current directory and /bin. As things evolved, I started using a ramdisk to create a more complete root namespace, binding /boot under /bin, and eventually using a paqfs to hold binaries, but there were still coded-in assumptions about things being found in /boot.

Additionally, 9front has its own minimal boot environment created for its own bootrc script, although that environment isn't preserved or accessible later. However, there was a lot of duplication between the contents of the 9front bootfs.paq and the ANTS bootpaq. The plan9rc boot and ANTS scripts were pretty much just ignoring the 9front bootpaq.

So, the goals of paying down the technical debt are:

* Remove the use of a tweaked rc and rcmain and including boot in the default path
* Remove duplication of resources between the standard 9front bootfs.paq and ANTS bootpaq
* Remove unneeded divergences/special-cases between ANTS boot and standard 9front boot

### Compile, Reboot, Compile and Reboot again

This kind of work has a fairly painful and time consuming development workflow. When the program being modified and debugged is the entire kernel and each test run requires rebooting a machine, the process of making small incremental changes, and testing them and fixing problems is quite time consuming. I do my testing and debugging using some of my vultr vps nodes, which is relatively quick and painless compared to working with physical hardware, but still involves a lot of repeated cpu-ing, repository syncing, and web console management-ing. 

The first thing to do was fix something that was broken in the plan9rc script: use of the Cache File Server (cfs) to speed up the use of filesystems acquired from the network. I had a completely broken line of code that looked like this:

	cfs -a tcp!$fs!564 -f $cfs -z boot

The biggest problem here is that cfs doesn't even HAVE a -z flag. I had at one point made a customized cfs which did have a -z flag to provide a file descriptor in /srv, but I had moved that to "retired" awhile ago, and I can't remember if it ever actually worked properly. So, I did what all good coders do: borrow code that actually works. I just took how the 9front bootrc sets up cfs using an existing /srv/boot and adopted it:

	{/bin/cfs -s -f $cfs </srv/boot &} | echo 0 >/srv/cfs
	mv /srv/boot /srv/boot.nocfs
	mv /srv/cfs /srv/boot

With that taken care of, there was some more cleanup to be done in the handling of the bootargs variable and starting the root fileserver. When I adapted plan9rc to 9front, I left fossil and kfs under the heading "case local" in the "dogetrootfs" fn, with different cases for cwfs and hjfs. This was based on some weird parsing logic, and 9front has ditched kfs anyway. Unlike fossil+venti, I don't see any reason to try to preserve kfs support in ANTS, so I restructured the bootargs parsing and dogetrootfs case structure to have a more consistent treatment of the different disk fs options. Additionally, I added some trivial sanity checks and simple auto-detection logic, so for instance the cwfs case does:

	if (! test -e $bootpartition)
		bootpartition=`{ls /dev/sd*/fscache}

To try to locate the correct fs on disk if the user supplied data isn't correct.
