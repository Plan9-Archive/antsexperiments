#!/bin/rc

# desc: choose and mount file system partition

sname=fossil

switch($1){
case go
	echo
	echo Please choose drive with fossil and venti arenas+isect partitions
	echo

	if (~ $#fsdisk 1)
		default=(-d $fsdisk)
	if not
		default=()
	prompt $default 'Drive with fossil and venti partitions' $fsdisk
	fsdisk=$rd
	export fsdisk

	if(! test -f /dev/$fsdisk/fossil){
		echo 'Fossil partition not found!'
		mountfs=ready
		export mountfs
		exit oops
	}
	if(! test -f /dev/$fsdisk/arenas){
		echo 'Venti arenas partition not found!'
		mountfs=ready
		export mountfs
		exit oops
	}
	if(! test -f /dev/$fsdisk/isect){
		echo 'Venti isect partition not found!'
		mountfs=ready
		export mountfs
		exit oops
	}

	sed 's/ZZZZ/'$fsdisk'/g' initfossil.conf >/tmp/initfossil.conf
	sed 's/ZZZZ/'$fsdisk'/g' fossil.conf >/tmp/fossil.conf
	sed 's/ZZZZ/'$fsdisk'/g' venti.conf >/tmp/venti.conf
	fs=/dev/$fsdisk/fossil
	export fs
	fsflags=()
	export fsflags

	log Starting $fstype file server for $fs
	unmount /n/newfs >[2]/dev/null

	fossil/flfmt $fs
	fossil/conf -w $fs /tmp/initfossil.conf
	fossil/fossil -f $fs
	mount -c /srv/fossil /n/fossil
#	bind /tmp/stub /n/dist/mail
#	disk/mkfs -U -z 8192 -s /n/dist -d /n/fossil /sys/lib/sysconfig/proto/allproto
#	echo 'home=/usr/$user; cd; . $home/lib/profile' >>/n/fossil/rc/bin/termrc
	fossil/conf -w $fs /tmp/fossil.conf
	venti/fmtarenas arenas /dev/$fsdisk/arenas
	venti/fmtisect isect /dev/$fsdisk/isect
	venti/fmtindex /tmp/venti.conf
	venti/conf -w /dev/$fsdisk/arenas /tmp/venti.conf

	log Mounting $fstype file server for $fs
	while(! logprog mount -c /srv/$sname /n/newfs)
		sleep 2

case checkready checkdone
	if(! ~ $fstype '' && ~ $#fs 1 && test -f $fs){
		if(test -f /srv/$sname && test -d /n/newfs/adm){
			mountfs=done
			export mountfs
			exit
		}
	}
	mountfs=ready
	export mountfs
	exit
}
