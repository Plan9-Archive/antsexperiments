#!/boot/rc
# ramroot startup after newns

fn shifter{
	shift
	echo $*
}

fn errorshell{
	echo subshell output on stderr >>/fd/2
	rc -i >>/fd/2
	echo exiting rc >>/fd/2
}

fn getans{
	query=$1
	value=`{shifter $*}
	echo '* '$query is':' $value - accept, new value, '"'clear'"', or '"'rc'"' : >>/fd/2
	answer=`{read}
	switch($answer){
	case rc
		errorshell
		getans $query $value
	case clear
		echo ''
	case ?*
		echo $answer
	case ''
		echo $value
	}
}

keyowner=`{cat /dev/hostowner}
if (! ~ $keyowner ?*){
	echo please set hostowner
	exit ''
}
usercheck=`{cat /dev/user}
if (! ~ $usercheck $keyowner){
	echo current user is not hostowner
	exit ''
}
if(~ $cpuport '')
	cpuport=17020

echo 'INITSKEL minimal setup for rootless plan 9 environment'
if(~ $interactive yes){
	echo 'For configuration questions, answer no to disable default behaviors'
	echo 'bind hardware devices?'
	binddevs=`{getans binddevs $binddevs}
	echo 'use current factotum key for this environment?'
	hostfactotum =`{getans hostfactotum $hostfactotum}
	if(~ $hostfactotum no){
		privpassword=`{getans privpassword $privpassword}
		passdom=`{getans passdom $passdom}
	}
	echo 'ipconfig if no internet is found?'
	netsvc=`{getans netsvc $netsvc}
	echo 'start cpu and rx listener ?'
	cpusvc=`{getans cpusvc $cpusvc}
	echo 'port for cpu listener if started?'
	cpuport=`{getans cpuport $cpuport}
	echo 'start persistent rc hub?'
	hubsvc=`{getans hubsvc $hubsvc}
}

if(! ~ $binddevs no){
	echo -n 'binddevs...'
	for(i in f t m v L P u U '$' Σ κ)
		bind -a '#'^$i /dev >/dev/null >[2=1]
}

echo -n 'mntgen...'
if(! test -e /srv/slashn)
	mntgen -s slashn && chmod 666 /srv/slashn
if not
	mntgen

if(~ $hostfactotum no){
	@{rfork nm && factotum -s hostfactotum}
	echo private hostfactotum started
	mount -b /srv/hostfactotum /mnt
	if(! ~ $privpassword ''){
		echo 'setting '$keyowner' factotum key'
		echo 'key proto=p9sk1 dom='$passdom' user='$keyowner' !password='^$privpassword >/mnt/factotum/ctl
		rm /env/privpassword
	}
}
if(! ~ $netsvc no){
	if(! test -e /net/ipifc/0/ctl){
		echo -n 'ipconfig ' $ipparams '...'
		ipconfig $ipparams
		ipconfig loopback /dev/null 127.1
	}
}
if(~ $justipconfig no){
	echo -n 'cs and dns -r...'
	cs
	dns -r
}
if(! ~ $hubsvc no){
	echo -n 'hubfs...'
	hub -b hubfs
}
if(! ~ $cpusvc no){
	echo -n 'listen1 cpu -R...'
	listen1 -t tcp!*!$cpuport /boot/cpu -R &
	listen1 -t tcp!*!17009 /boot/rexexec &
}


if(~ $ordinary no){
	if(! test -e /x/adm/keys){
		echo -n das doskeys...
		if(! test -e /srv/dos)
			dossrv
		mount /srv/dos /x /dev/sdC0/9fat	
	}
	cat /x/adm/keys >/adm/keys
	echo -n keyfs...
	keyfs -wp -m /mnt/keys /adm/keys
#	echo cron...
#	cron >>/sys/log/cron >[2=1] &
	echo -n authsrv...
	listen1 -tv tcp!*!567 authsrv -d &
}

if(~ $staysane no){
	echo 'exporting writable root to the whole internet on port 17007!!!'
	listen1 -t tcp!*!17007 /boot/exportfs &
}
if(~ $font ''){
	font=/lib/font/bit/lucm/latin1.9.font
}

save9cfg init
exit ''
