#!/boot/rc
# rootless environment startup script by mycroftiv

fn getans{
	echo '* '$1 is':' $2 - accept, new value, '"'clear'"', or '"'rc'"' : >>/fd/2
	answer=`{read}
	switch($answer){
	case rc
		errorshell
		getans $1 $2
	case clear
		echo ''
	case ?*
		echo $answer
	case ''
		echo $2
	}
}

fn findpart{
	if((test -e /boot/sed) || (test -e /bin/sed)){
		echo $bootparse(1) |sed 's/.*#./\/dev/'
	}
	if not {
		if(~ $bootparse(1) *sdC0/$1)
			echo /dev/sdC0/$1
		if(~ $bootparse(1) *sdC1/$1)
			echo /dev/sdC1/$1
		if(~ $bootparse(1) *sdD0/$1)
			echo /dev/sdD0/$1
		if(~ $bootparse(1) *sdD1/$1)
			echo /dev/sdD1/$1
	}
}

fn hostcheck{
	hosttest=`{cat /dev/hostowner}
	if(~ $hosttest ''){
		if(~ $user ''){
			user=bootes
		}
		echo 'no hostowner found: setting to '$user
		echo -n $user >'/dev/hostowner'
	}
	if(~ $user ''){
		user=`{cat /dev/hostowner}
	}
}

fn doramsetup{
	switch($ramsetup){
	case ''
		echo no ramsetup
	case ?*
		hostcheck
		echo ramsetup $ramsetup
		rc -c $ramsetup
	}
}

fn dofactotum{
	switch($factotum){
	case ''
		echo no factotum
	case cpu
		echo cpu factotum
		factotum -S -s factotum
	case terminal
		echo terminal factotum
		factotum -u -s factotum
	case debug
		hostcheck
		echo debug factotum
		factotum -d -s factotum
	}
}

# usb COMPLETELY UNTESTED just trying to imitate the new code in usb.c
fn dotryusb{
	if(~ $tryusb yes){
		if (test -e /dev/usb/ctl) {
			echo -n usb...
			usbd /srv/usb
			sleep 3
			if(! ~ $sdB0part '')
				partfscmd=`{echo '-p '$sdB0part}
			partfs $partfscmd -s /srv/partfs.sdXX /dev/sdU0.0
			chmod 666 /srv/partfs.sdXX
		}
	}
}

fn ipsetup{
	if(! test -e /net/ipifc/0/ctl){
		if(~ $gateway ?*){
			ipparams=( -g $gateway ether /net/ether0 $ipaddress $ipmask )
		}
		echo ipconfig $ipparams
		ipconfig $ipparams
		ipconfig loopback /dev/null 127.1
		ipdone=yes
	}
}

fn doafterfact{
	switch($afterfact){
	case ?*
		echo after factotum command $afterfact
		rc -c $afterfact
	case ''
		echo -n ''
	}
}

fn dostartventi{
	switch($startventi){
	case yes
		echo starting venti
		if(! ~ $ipdone yes){
			ipsetup
		}
		venti -c $venticonf -a $ventilisten -h $vhttplisten
		venti=tcp!127.1!17034
	case later
		echo ok you can start venti later that is fine
	}
}

fn dogetrootfs{
	switch($getrootfs){
	case tcp
		if(! ~ $bootargs tcp){
			bootargs='tcp!'$fs'!564'
		}
		if(! ~ $ipdone yes){
			ipsetup
		}
		if(~ $cfs ''){
			echo srv $fs to /srv/boot...
			if(~ $fs tcp*)
				srv $fs boot
			if not
				srv tcp!$fs!564 boot
			bootsrv=/srv/boot
		}
		if not{
			echo starting cfs $cfs dialing $fs and serving root to /srv/boot...
			if(~ $fs tcp*)
				cfs -a $fs -f $cfs -z boot
			if not
				cfs -a tcp!$fs!564 -f $cfs -z boot
			bootsrv=/srv/boot
		}
	case local
		if(~ $kfs ''){
			if(! ~ $fossil ?*){
				partition=`{findpart fossil}
				if(~ $interactive yes){
					echo 'parsed fossil partition as ' $partition ' enter new value if this is incorrect'
					partition=`{getans partition $partition}
				}
#				else if(! ~ $partition *fossil){
#					echo $partition ' doesnt look like a fossil, trying /dev/sdC0/fossil as default'
#					partition=/dev/sdC0/fossil
#				}
				fossil=$partition
			}
			if(! ~ $venti ''){
				if(! ~ $ipdone yes){
					ipsetup
				}
			}
			echo starting fossil from $fossil...
			fossil -f $fossil -c 'srv -p fscons'
			echo 'srv -A boot' >>/srv/fscons
			bootsrv=/srv/boot
		}
		if not{
			if(! ~ $kfs ?*){
				partition=`{findpart kfs}
				if(~ $interactive yes){
					echo 'parsed kfs partition as ' $partition ' enter new value if this is incorrect'
					partition=`{getans partition $partition}
				}
				kfs=$partition
			}
			partition=`{findpart kfs}
#			if(! ~ $partition *kfs){
#				echo $partition ' doesnt look like , please enter partition'
#				partition=`{getans partition $partition}
#			}
			kfs=$partition
			echo starting kfs from $kfs...
			kfs -f $kfs -n boot
			bootsrv=/srv/kfs.boot
		}
	case ''
		echo no standard root fs attached
	}
}

fn doafterroot{
	switch($afterroot){
	case ?*
		echo afterroot command $afterroot
		rc -c $afterroot
	case ''
		echo -n ''
	}
}

fn doinitscript{
	switch($initscript){
	case ?*
		newns -n /boot/$namespace $initscript
	case easteregg
		echo guess i should make an easter egg here
	}
}

fn dochecksys{
	systest=`{cat /dev/sysname}
	switch($sysname){
	case ?*
		if(~ $systest ''){
			echo setting /dev/sysname to $sysname
			echo -n $sysname >/dev/sysname
			systest=`{cat /dev/sysname}
		}
		if(! ~ $systest $sysname){
			echo warning sysname mismatch between dev and env
		}
	case ''
		if(~ $systest ''){
			if(~ $service cpu){
				sysname=helix
			} 
			if(~ $service terminal){
				sysname=gnot
			}
			if(~ $sysname ''){
				sysname=mutant
			}
			echo no sysname found in dev or env setting to $sysname
			echo -n $sysname >/dev/sysname
		}
		if not{
			echo setting sysname var to $systest from /dev/sysname
			sysname = $systest
		}
	}
}

fn dorootstart{
	switch($rootstart){
	case cpu
		echo mounting $bootsrv to /root and starting cpurc
		mount $bootsrv /root
		newns -n /root/lib/namespace /root/rc/bin/cpurc
	case terminal
		echo mounting $bootsrv to /root and starting termrc
		mount $bootsrv /root
		if(~ $user ''){
			user=`{cat /dev/hostowner}
		}
		home=/usr/$user
		newns -n /root/lib/namespace /root/rc/bin/termrc
		newns -n /root/lib/namespace rc -c 'cd; . $home/lib/profile'
	case ''
		echo not starting externally rooted startup scripts
	}
}

fn errorshell{
	echo subshell output on stderr >>/fd/2
	rc -i >>/fd/2
	echo exiting rc >>/fd/2
}

############# End of fn definitions #################
echo 'ROOTLESS PLAN 9 /boot/plan9rc'
# Begin by parsing plan9.ini options and trying to set sane defaults

cat '#r/rtc' > '#c/time'

if(! ~ $1 '')
	. $1
if(~ $bootargs ''){
	bootargs=local!#S/sdC0/fossil
	interactive=yes
	echo 'no bootargs found using '$bootargs' and setting interactive=yes'
}
bootparse=`{echo $bootargs}
if(~ $bootparse(1) local*)
	getrootfs=local
if(~ $bootparse(1) tcp*)
	getrootfs=tcp
if(~ $ramsetup '')
	ramsetup=ramskel
if(~ $initscript '')
	initscript=initskel
#if(~ $tgzfs '')
#	tgzfs=rootfs.tgz
if(~ $namespace '')
	namespace=namespace
if(~ $factotum '')
	factotum=`{cat '/env/service'}
if(~ $rootstart '')
	rootstart=`{cat '/env/service'}
ventiparse=`{echo $venti}
venticonf=$ventiparse(1)
ventilisten=$ventiparse(2)
vhttplisten=$ventiparse(3)
if(~ $venticonf '#'*)
	startventi=yes
if(~ $venticonf '')
	venticonf=/dev/sdC0/arenas
if(~ $ventilisten '')
	ventilisten=tcp!*!17034
if(~ $vhttplisten '')
	vhttplisten=tcp!127.1!8000


if(~ $interactive yes){
	echo Interactive Startup - enter to continue to options or type rc for a shell
	answer=`{read}
	if(~ $answer rc){
		echo dropping to rc shell with limited commands
		rc -i
	}
	echo 'Internet config DHCP by default. Enter ipconfig parameters if needed'
	ipparams = `{getans ipparams $ipparams}
	echo 'Choose factotum mode - cpu terminal or debug.'
	factotum = `{getans factotum $factotum}
	dofactotum
	dotryusb
	sysname = `{getans sysname $sysname}
	echo 'Skeleton fs required for mountpoints. Default ramskel recommended.'
	ramsetup = `{getans ramsetup $ramsetup}
	echo 'Load optional tools from 9fat? Enter rootfs.tgz small.tgz or no'
	tgzfs = `{getans tgzfs $tgzfs}
	doramsetup
	hostcheck
	echo 'Start local Venti? Enter yes if so.'
	startventi = `{getans startventi $startventi}
	if(~ $startventi yes){
		ventilisten = `{getans ventilisten $ventilisten}
		vhttplisten = `{getans vhttplisten $vhttplisten}
	}
	dostartventi
	echo 'Attach to a file server? Choose local or tcp or leave blank for none.'
	getrootfs = `{getans getrootfs $getrootfs}
	if(~ $getrootfs tcp){
		fs = `{getans fs $fs}
		auth = `{getans auth $auth}
		cfs = `{getans cfs $cfs}
	}
	if(~ $getrootfs local){
		echo 'Dial a venti server? Enter a dialstring or ip if so.'
		venti = `{getans venti $venti}
		if(! ~ $venti ''){
			if(! ~ $venti tcp*)
				venti=tcp!^$venti^!17034
		}
		if(~ ! venti ''){
			ipsetup
		}
	}
	dogetrootfs
	echo 'Create cpu server namespace on a port of your choice? Initskel if so.'
	initscript = `{getans initscript $initscript}
	doinitscript
	dochecksys
	echo 'Start cpurc termrc from the file server? Enter cpu or terminal if so.'
	rootstart = `{getans rootstart $rootstart}
	if(~ $rootstart cpu)
		service=cpu
	if(~ $rootstart terminal)
		service=terminal
	dorootstart
	echo '#c' `{cat '#c/user'} `{cat '#c/sysname'} /env $user $sysname
	echo 'Keep console in ramboot namespace? yes if so.'
	staylocal = `{getans staylocal $staylocal}
	echo 'storing startup configuration to ramdisk in /usr/'$user'/tmp/p9cfg'
	save9cfg
	if(~ $staylocal yes){
		echo starting mntgen and shell in current namespace
		home=/usr/$user
		mntgen
		rc -i
	}
}

if not {
	dofactotum
	dotryusb
	doramsetup
	hostcheck
	doafterfact
	dostartventi
	dogetrootfs
	doafterroot
	doinitscript
	dochecksys
	dorootstart
	echo '#c' `{cat '#c/user'} `{cat '#c/sysname'} /env $user $sysname
	echo 'storing startup configuration to ramdisk in /usr/'$user'/tmp/p9cfg'
	save9cfg
	if(~ $staylocal yes){
		echo starting mntgen and shell in current namespace
		home=/usr/$user
		mntgen
		rc -i
	}
}
exit ''
