#!/boot/rc

# rerootwin targetsrv [ authagent ]

if(test -e /lib/namespace.saveterm)
	nsfile=/lib/namespace.saveterm
if(test -e /boot/namespace.saveterm)
	nsfile=/boot/namespace.saveterm
if(~ $nsfile ''){
	echo no namespace.saveterm found
	exit
}

pivot=/net.alt
while (~ $1 -*){
	switch($1){
	case -u
		pivot=/u
		shift
	case -n
		pivot=/n
		shift
	}
}
if(! ~ $1 ?*){
	echo need a target srv
	exit
}
if(! test -e /mnt/wsys/wctl){
	if(! test -e /mnt/term/mnt/wsys/wctl){
		echo no wctl at mnt wsys
		exit
	}
	echo binding /mnt/term/mnt/wsys to /mnt/wsys
	bind /mnt/term/mnt/wsys /mnt/wsys
}
if(! test -e /mnt/term/dev/cons){
	if(! test -e /mnt/wsys/cons){
		echo no cons at mnt term
		exit
	}
	if(! test -e /mnt/term/dev)
		mkdir /mnt/term/dev
	echo binding /mnt/wsys /mnt/term/dev
	bind /mnt/wsys /mnt/term/dev
}
if(! test -e /srv/$1){
	srv tcp!$1!564 $1
	if(! test -e /srv/$1){
		echo srv $1 couldnt be acquired
		exit
	}
}
nsroot=$1
if(~ $2 ?*){
	authagent=$2
}
if not if(! ~ $authagent ?*){
	authagent=factotum
}
if(! test -e /srv/$authagent){
	factotum -s $authagent
}
mount -b /srv/$authagent /mnt

oldterm=oldterm.$pid
oldwsys=oldwsys.$pid

srvfs -p 0600 oldterm.$pid /mnt/term
srvfs -p 0600 oldwsys.$pid /mnt/wsys

if(test -e /bin/newns){
	newns -n $nsfile
	exit
}

auth/newns -n $nsfile
