#!/bin/rc
# DANGER! This script obliterates fossils and resets them to a different score

# fosreset rootscore [fossil] [venti]
score=$1
if(! ~ $score ????????????????*){
	echo $1 is not a fossil root score
	exit ''
}
fossil=$2
if(~ $fossil '')
	fossil=/dev/sdC0/fossil
if(! ~ $3 '')
	venti=$3
if(~ $venti ''){
	echo 'please set a target for your fossil!'
	exit ''
}
if(~ $fossil tcp*){
	echo not disk
	exit ;;
}

echo '!resetting '$fossil' on '$sysname' backed by venti '$venti' foshalt in 3 seconds!!'
sleep 3
if(! test -e /bin/foshalt)
	fshalt
if not
	foshalt
echo -n killing fossil processes...
kill fossil |rc
sleep 1
Kill fossil |rc
sleep 2
slay fossil |rc
sleep 1
stillhere=`{ps |grep fossil}
if(! ~ $stillhere ''){
	echo 'fossil processes still running! exiting'
	exit ''
}

if(~ $score vac*)
	score=`{echo $score |sed 's/vac://g'}
echo 'last change to save fossil '$fossil' reformat in 3 seconds!'
sleep 3
echo issuing flfmt -y -v $score $fossil
if(test -e /bin/flfmt)
	flfmt -y -v $score $fossil
if not
	fossil/flfmt -y -v $score $fossil
