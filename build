#!/bin/rc

if(! test -e bootdir.extras){
	echo this build script MUST be run only from the base rootless directory
	exit wrong.dir
}
rfork ne
builddir=`{pwd}
bind -b $builddir/src.9.boot /sys/src/9/boot
bind -b $builddir/src.9.port /sys/src/9/port
bind -b $builddir/src.9.pc /sys/src/9/pc
bind -b $builddir/scripts /bin
bind $builddir /n/rootless
bind -bc $builddir/compiletemp /sys/src/9/pc
if(~ $1 everything){
	echo building everything
	build clean
	build patched
	build tools
	build extras
	build bootpaq
	build
	exit ''
}
if(~ $1 clean){
	echo building mk clean
	cd /sys/src/9/pc
	mk clean
	cd $builddir
	exit
}
if(~ $1 patched){
	echo building patched
	ramfs
	mkdir /tmp/rc
	mkdir /tmp/factotum
	dircp /sys/src/cmd/rc /tmp/rc
	dircp /sys/src/cmd/auth/factotum /tmp/factotum
	cp patched/rc.plan9.c /tmp/rc/plan9.c
	cp patched/factotumdat.h /tmp/factotum/dat.h
	cp patched/factotumfs.c /tmp/factotum/fs.c
	cp patched/factotumutil.c /tmp/factotum/util.c
	cd /tmp/rc
	mk
	cp 8.out $builddir/bootdir.extras/rc
	cd /tmp/factotum
	mk 8.factotum
	cp 8.factotum $builddir/bootdir.extras/factotum
	cd $builddir
	rm -rf /tmp/rc
	rm -rf /tmp/factotum
	exit
}	
if(~ $1 extras){
	echo building extras
	cd grio
	mk clean
	mk
	cp 8.out ../bootdir.extras/grio
	cd ../hubfs1.1
	rm hubfs
	rm hubshell
	rm *.8
	8c -FTVw hubfs.c
	8l -o hubfs hubfs.8
	8c -FTVw hubshell.c
	8l -o hubshell hubshell.8
	cp hubfs ../bootdir.extras
	cp hubshell ../bootdir.extras
	cp hub ../bootdir.extras
	exit
}
if(~ $1 bootpaq){
	echo building bootpaq
	rm root/bin/*
	cp root/lib/_mkpaq root/bin
	cd root/bin
	. _mkpaq
	cd $builddir
	mkpaqfs -o bootdir.extras/bootpaq root/bin
	exit
}
if(~ $1 tools){
	echo building tools
	rm root/bin/*
	cp root/lib/_toolcopy root/bin
	cd root/bin
	. _toolcopy
	cd $builddir
	ramfs -m /tmp
	tar cf /tmp/tools.tar root
	gzip -9 -c /tmp/tools.tar >tools.tgz
	rm /tmp/tools.tar
	cd $builddir
	exit
}
echo building kernel
cp scripts/* bootdir.extras/root/bin
cd bootdir.extras
rm skel.tar
tar cf skel.tar root
if(~ $1 ramfs){
	echo building kernel in tmp
	ramfs -m /tmp
	bind -bc /tmp /sys/src/9/pc
}
cd /sys/src/9/pc
mk 'CONF=pcram'
gzip -9 -c 9pcram > $builddir/compiletemp/9pcram.gz
exit ''
